# Deep face segmentation in extremely hard conditions

[![Docker Image CI](https://github.com/SajjadAemmi/face_segmentation/actions/workflows/docker-image.yml/badge.svg)](https://github.com/SajjadAemmi/face_segmentation/actions/workflows/docker-image.yml)

![alt text](https://yuvalnirkin.github.io/assets/img/projects/face_segmentation/face_segmentation_teaser.jpg "Samples")  
COFW sample images segmented using our method.

[Yuval Nirkin](http://www.nirkin.com/), [Iacopo Masi](http://www-bcf.usc.edu/~iacopoma/), [Anh Tuan Tran](https://sites.google.com/site/anhttranusc/), [Tal Hassner](http://www.openu.ac.il/home/hassner/), and [Gerard Medioni](http://iris.usc.edu/people/medioni/index.html).

## News (10/07/18)
- [New FCN model](https://github.com/YuvalNirkin/face_segmentation/releases/download/1.1/face_seg_fcn8s_300_no_aug.zip) released for lower resolution images (300X300), trained without augmentations. Useful if you have limited GPU memory.
- A better performing and more efficient U-Net model will be released soon, including training and inference scripts using PyTorch.  

## Overview
This project provides an interface for face segmentation using Caffe with a fully convolutional neural network.
The network was trained on IARPA Janus CS2 dataset (excluding subjects that are also in [LFW](http://vis-www.cs.umass.edu/lfw/)) using a novel process for collecting ground truth face segmentations, involving our tool for [semi-supervised Face video segmentation](https://github.com/YuvalNirkin/face_video_segment). Additional synthetic images were generated by augmenting hands from the [EgoHands dataset](http://vision.soic.indiana.edu/projects/egohands/), and augmenting 3D models of glasses and microphones.

If you find this code useful, please make sure to cite our paper in your work:

Yuval Nirkin, Iacopo Masi, Anh Tuan Tran, Tal Hassner, Gerard Medioni, "[On Face Segmentation, Face Swapping, and Face Perception](https://arxiv.org/abs/1704.06729)", IEEE Conference on Automatic Face and Gesture Recognition (FG), Xi'an, China on May 2018

## Installation
Download the [face_seg_fcn8s.zip](https://github.com/YuvalNirkin/face_segmentation/releases/download/1.0/face_seg_fcn8s.zip) or [face_seg_fcn8s_300_no_aug.zip](https://github.com/YuvalNirkin/face_segmentation/releases/download/1.1/face_seg_fcn8s_300_no_aug.zip) and extract to "data" in the installation directory.

## Docker Inference

build docker, then run it for inference. 

`--input` argument can be a single image path or a directory path

### GPU
Build the docker image

```
docker build -t face_segmentation:gpu .
```
Run the docker image
```
nvidia-docker run -it -v /path/to/face_segmentation:/workspace/face_segmentation face_segmentation:gpu --input ./input
```

### CPU
If you want build cpu version of docker, first go to `./Dockerfile`, comment first line and uncomment second line. 

Build the docker image

```
docker build -t face_segmentation:cpu .
```
Run the docker image
```
docker run -it -v /path/to/face_segmentation:/workspace/face_segmentation face_segmentation:cpu --input ./input
```

Note: The segmentation model was trained by cropping the training images using [find_face_landmarks](https://github.com/YuvalNirkin/find_face_landmarks). For best results crop the input images the same way, with crop resolution below 350 X 350. A Matlab function is available [here](https://github.com/YuvalNirkin/find_face_landmarks/blob/master/interfaces/matlab/bbox_from_landmarks.m).


## Citation

Please cite our paper with the following bibtex if you use our face segmentation network:

``` latex
@inproceedings{nirkin2018_faceswap,
      title={On Face Segmentation, Face Swapping, and Face Perception},
      booktitle = {IEEE Conference on Automatic Face and Gesture Recognition},
      author={Nirkin, Yuval and Masi, Iacopo and Tran, Anh Tuan and Hassner, Tal and Medioni, and G\'{e}rard Medioni},
      year={2018},
    }
```

## Related projects
- [End-to-end, automatic face swapping pipeline](https://github.com/YuvalNirkin/face_swap), example application using out face segmentation method.
- [Interactive system for fast face segmentation ground truth labeling](https://github.com/YuvalNirkin/face_video_segment), used to produce the training set for our deep face segmentation.
- [CNN3DMM](http://www.openu.ac.il/home/hassner/projects/CNN3DMM/), estimation of 3D face shapes from single images.
- [ResFace101](http://www.openu.ac.il/home/hassner/projects/augmented_faces/), deep face recognition used in the paper to test face swapping capabilities. 

## Copyright
Copyright 2017, Yuval Nirkin, Iacopo Masi, Anh Tuan Tran, Tal Hassner, and Gerard Medioni 

The SOFTWARE provided in this page is provided "as is", without any guarantee made as to its suitability or fitness for any particular use. It may contain bugs, so use of this tool is at your own risk. We take no responsibility for any damage of any sort that may unintentionally be caused through its use.
